<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Proyectos - Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="container">
      <a href="index.html" class="logo">Crowdfunding</a>
      <nav id="mainNav"></nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="flex items-center gap-3 mb-6">
        <span style="font-size: 32px;">✅</span>
        <div>
          <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 4px;">Gestión de Proyectos</h1>
          <p class="text-muted">Revisar, aprobar y gestionar todos los proyectos de la plataforma</p>
        </div>
      </div>

      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="card">
          <div class="card-content">
            <div class="text-sm text-muted mb-2">Total Proyectos</div>
            <div style="font-size: 24px; font-weight: 700;" id="totalProjects">0</div>
          </div>
        </div>
        <div class="card" style="background: #eff6ff; border-color: #bfdbfe;">
          <div class="card-content">
            <div class="text-sm mb-2" style="color: #1e40af;">Pendientes de Revisión</div>
            <div style="font-size: 24px; font-weight: 700; color: #1e40af;" id="pendingProjects">0</div>
          </div>
        </div>
        <div class="card" style="background: #dcfce7; border-color: #22c55e;">
          <div class="card-content">
            <div class="text-sm mb-2" style="color: #166534;">Publicados</div>
            <div style="font-size: 24px; font-weight: 700; color: #166534;" id="publishedProjects">0</div>
          </div>
        </div>
        <div class="card" style="background: #fef3c7; border-color: #f59e0b;">
          <div class="card-content">
            <div class="text-sm mb-2" style="color: #92400e;">Con Observaciones</div>
            <div style="font-size: 24px; font-weight: 700; color: #92400e;" id="observedProjects">0</div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-6">
        <span class="text-sm" style="font-weight: 500;">Filtrar por estado:</span>
        <select id="statusFilter" class="select" style="width: 200px;" onchange="filterProjects()">
          <option value="all">Todos los estados</option>
          <option value="under_review">En Revisión</option>
          <option value="observed">Observado</option>
          <option value="published">Publicado</option>
          <option value="rejected">Rechazado</option>
          <option value="draft">Borrador</option>
        </select>
      </div>

      <div id="projectsList"></div>
    </div>
  </main>

  <div class="modal" id="actionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Acción</h2>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2024 Crowdfunding Platform. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script src="data.js"></script>
  <script>
  (function(){ if (typeof window.updateNavigation === 'function') return; 
  if (typeof window.logout !== 'function') window.logout = function(){};
    function _getNavUser(){ if (typeof getCurrentUser === 'function'){ try{ const u = getCurrentUser(); if (u) return u; }catch(e){} } return { name: 'Usuario Demo', email: 'demo@ejemplo.com', role: 'user' }; }
    window.updateNavigation = function(){ const nav = document.getElementById('mainNav'); if (!nav) return; const user = _getNavUser(); if (!user){ nav.innerHTML = `<a href="index.html">Inicio</a><a href="projects.html">Proyectos</a><a href="login.html" class="btn btn-primary">Iniciar Sesión</a>`; } else if (user.role === 'admin'){ nav.innerHTML = `<a href="index.html">Inicio</a><a href="projects.html">Proyectos</a><a href="admin-projects.html">Gestión Proyectos</a><a href="admin-users.html">Gestión Usuarios</a><div class="user-menu"><button class="btn btn-outline" onclick="toggleUserMenu()">${user.name} ▼</button><div class="dropdown-menu" id="userDropdown"><span class="dropdown-item" style="font-weight: 600; cursor: default;">Administrador</span><div class="separator" style="margin: 8px 0;"></div><a href="favorites.html" class="dropdown-item">Favoritos</a><a href="my-donations.html" class="dropdown-item">Mis Aportes</a><div class="separator" style="margin: 8px 0;"></div><span class="dropdown-item" onclick="logout()">Cerrar Sesión</span></div></div>`; } else { nav.innerHTML = `<a href="index.html">Inicio</a><a href="projects.html">Proyectos</a><a href="my-projects.html">Mis Proyectos</a><div class="user-menu"><button class="btn btn-outline" onclick="toggleUserMenu()">${user.name} ▼</button><div class="dropdown-menu" id="userDropdown"><span class="dropdown-item" style="font-weight: 600; cursor: default;">${user.email}</span><div class="separator" style="margin: 8px 0;"></div><a href="my-projects.html" class="dropdown-item">Mis Proyectos</a><a href="my-donations.html" class="dropdown-item">Mis Aportes</a><a href="favorites.html" class="dropdown-item">Favoritos</a><div class="separator" style="margin: 8px 0;"></div><span class="dropdown-item" onclick="logout()">Cerrar Sesión</span></div></div>`; } };
    window.toggleUserMenu = function(){ const dropdown = document.getElementById('userDropdown'); if (dropdown) dropdown.classList.toggle('active'); };
    document.addEventListener('click', function(e){ const userMenu = document.querySelector('.user-menu'); const dropdown = document.getElementById('userDropdown'); if (userMenu && dropdown && !userMenu.contains(e.target)) dropdown.classList.remove('active'); });
    window.toggleFavorite = function(projectId){ if (!Array.isArray(window.projects)) return; const p = projects.find(p=>p.id===projectId); if (p) p.isFavorite = !p.isFavorite; };
    window.formatDate = function(dateString){ try{ const d = new Date(dateString); return d.toLocaleDateString('es-ES',{ year: 'numeric', month: 'long', day: 'numeric' }); }catch(e){ return dateString; } };
    window.getDaysLeft = function(deadlineString){ try{ const deadline = new Date(deadlineString); const today = new Date(); const diffTime = deadline - today; return Math.ceil(diffTime/(1000*60*60*24)); }catch(e){ return 0; } };
    window.getStatusBadge = function(status){ const statusMap = { draft: { label: 'Borrador', class: 'badge-secondary' }, under_review: { label: 'En Revisión', class: 'badge-primary' }, published: { label: 'Publicado', class: 'badge-success' }, observed: { label: 'Observado', class: 'badge-warning' }, rejected: { label: 'Rechazado', class: 'badge-destructive' } }; const info = statusMap[status] || { label: status, class: 'badge-secondary' }; return `<span class="badge ${info.class}">${info.label}</span>`; };
    window.getCampaignStatusBadge = function(status){ const statusMap = { not_started: { label: 'No Iniciada', class: 'badge-secondary' }, in_progress: { label: 'En Progreso', class: 'badge-success' }, paused: { label: 'En Pausa', class: 'badge-warning' }, finished: { label: 'Finalizada', class: 'badge-secondary' } }; const info = statusMap[status] || { label: status, class: 'badge-secondary' }; return `<span class="badge ${info.class}">${info.label}</span>`; };
    window.requireAuth = function(){ return true; };
    window.requireAdmin = function(){ return true; };
  })();
  </script>
  <script>
    let currentAction = null;
    let currentProjectId = null;

    function initPage() {
      if (!requireAdmin()) return;
      updateNavigation();
      updateStats();
      filterProjects();
    }

    function updateStats() {
      document.getElementById('totalProjects').textContent = projects.length;
      document.getElementById('pendingProjects').textContent = projects.filter(p => p.status === 'under_review').length;
      document.getElementById('publishedProjects').textContent = projects.filter(p => p.status === 'published').length;
      document.getElementById('observedProjects').textContent = projects.filter(p => p.status === 'observed').length;
    }

    function filterProjects() {
      const statusFilter = document.getElementById('statusFilter').value;
      let filtered = projects;

      if (statusFilter !== 'all') {
        filtered = projects.filter(p => p.status === statusFilter);
      }

      renderProjects(filtered);
    }

    function renderProjects(projectsList) {
      const container = document.getElementById('projectsList');

      if (projectsList.length === 0) {
        container.innerHTML = `
          <div class="card">
            <div class="card-content text-center" style="padding: 60px;">
              <p class="text-muted">No hay proyectos que coincidan con el filtro seleccionado.</p>
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = projectsList.map(project => {
        const progress = (project.currentAmount / project.fundingGoal * 100).toFixed(1);
        const category = categories.find(c => c.name === project.category);

        return `
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex justify-between items-start">
                <div style="flex: 1;">
                  <div class="flex items-center gap-2 mb-2">
                    <h3 style="font-size: 18px; font-weight: 600;">${project.title}</h3>
                    ${getStatusBadge(project.status)}
                    <span class="badge badge-outline">${project.category}</span>
                  </div>
                  <p class="text-sm text-muted mb-2">${project.description}</p>
                  <div class="text-sm text-muted">
                    <span>Creador: ${project.ownerName}</span> •
                    <span>Creado: ${formatDate(project.createdAt)}</span>
                  </div>
                </div>
                <img src="${project.image}" alt="${project.title}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px;">
              </div>
            </div>
            <div class="card-content">
              <div class="grid grid-cols-3 gap-4 text-sm mb-4">
                <div>
                  <div class="text-muted">Meta de Financiación</div>
                  <div style="font-weight: 600;">$${project.fundingGoal.toLocaleString()}</div>
                </div>
                <div>
                  <div class="text-muted">Recaudado</div>
                  <div style="font-weight: 600;">$${project.currentAmount.toLocaleString()} (${progress}%)</div>
                </div>
                <div>
                  <div class="text-muted">Fecha Límite</div>
                  <div style="font-weight: 600;">${formatDate(project.deadline)}</div>
                </div>
              </div>

              ${category ? `
                <div class="mb-4">
                  <h4 style="font-weight: 500; margin-bottom: 8px;">Requisitos de la categoría "${project.category}":</h4>
                  <ul class="text-sm text-muted" style="list-style: none;">
                    ${category.requirements.map(req => `<li>• ${req}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}

              ${project.observations ? `
                <div class="alert alert-warning mb-4">
                  <h4 style="font-weight: 500; margin-bottom: 8px;">Observaciones Anteriores:</h4>
                  ${project.observations.map(obs => `<p class="text-sm">• ${obs}</p>`).join('')}
                </div>
              ` : ''}

              <div class="flex gap-2 flex-wrap">
                <a href="project-detail.html?id=${project.id}" class="btn btn-outline btn-sm">Ver Detalle Completo</a>
                
                ${project.status === 'under_review' ? `
                  <button class="btn btn-primary btn-sm" onclick="openActionModal('${project.id}', 'approve')">✅ Aprobar</button>
                  <button class="btn btn-outline btn-sm" onclick="openActionModal('${project.id}', 'observe')">⚠️ Observar</button>
                  <button class="btn btn-destructive btn-sm" onclick="openActionModal('${project.id}', 'reject')">❌ Rechazar</button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openActionModal(projectId, action) {
      currentProjectId = projectId;
      currentAction = action;
      const project = projects.find(p => p.id === projectId);
      const modal = document.getElementById('actionModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      if (action === 'approve') {
        modalTitle.textContent = 'Aprobar Proyecto';
        modalBody.innerHTML = `
          <p class="mb-4">¿Estás seguro de que quieres aprobar el proyecto "${project.title}"?</p>
          <p class="text-sm text-muted mb-6">El proyecto será publicado y podrá iniciar su campaña de recaudación.</p>
          <div class="flex gap-2">
            <button class="btn btn-primary" style="flex: 1;" onclick="executeAction()">Confirmar Aprobación</button>
            <button class="btn btn-outline" style="flex: 1;" onclick="closeModal()">Cancelar</button>
          </div>
        `;
      } else if (action === 'observe') {
        modalTitle.textContent = 'Marcar Proyecto como Observado';
        modalBody.innerHTML = `
          <p class="mb-4">Especifica qué aspectos del proyecto necesitan ser corregidos:</p>
          <textarea id="observationText" class="textarea mb-4" rows="4" placeholder="Detalla las observaciones y aspectos que deben ser subsanados..."></textarea>
          <div class="flex gap-2">
            <button class="btn btn-primary" style="flex: 1;" onclick="executeAction()">Enviar Observaciones</button>
            <button class="btn btn-outline" style="flex: 1;" onclick="closeModal()">Cancelar</button>
          </div>
        `;
      } else if (action === 'reject') {
        modalTitle.textContent = 'Rechazar Proyecto';
        modalBody.innerHTML = `
          <p class="mb-4" style="color: var(--destructive);">¿Estás seguro de que quieres rechazar este proyecto permanentemente?</p>
          <p class="text-sm text-muted mb-2">Especifica las razones del rechazo:</p>
          <textarea id="rejectionText" class="textarea mb-4" rows="4" placeholder="Motivos del rechazo del proyecto..."></textarea>
          <div class="flex gap-2">
            <button class="btn btn-destructive" style="flex: 1;" onclick="executeAction()">Confirmar Rechazo</button>
            <button class="btn btn-outline" style="flex: 1;" onclick="closeModal()">Cancelar</button>
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('actionModal').classList.remove('active');
      currentProjectId = null;
      currentAction = null;
    }

    function executeAction() {
      const project = projects.find(p => p.id === currentProjectId);
      
      if (currentAction === 'approve') {
        console.log('Aprobar proyecto:', currentProjectId);
        alert('Proyecto aprobado exitosamente');
      } else if (currentAction === 'observe') {
        const text = document.getElementById('observationText').value;
        if (!text.trim()) {
          alert('Por favor ingresa las observaciones');
          return;
        }
        console.log('Observar proyecto:', currentProjectId, text);
        alert('Observaciones enviadas exitosamente');
      } else if (currentAction === 'reject') {
        const text = document.getElementById('rejectionText').value;
        if (!text.trim()) {
          alert('Por favor ingresa las razones del rechazo');
          return;
        }
        console.log('Rechazar proyecto:', currentProjectId, text);
        alert('Proyecto rechazado');
      }

      closeModal();
    }

    initPage();
  </script>
</body>
</html>
